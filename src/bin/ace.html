<!DOCTYPE html>
<html>
<head>
<title>ace.coffee</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<link rel="stylesheet" media="all" href="/edify/css/docco.css">
</head>
<body>
<div id="container">
<div id="background"></div>
  <table cellspacing="0" cellpadding="0">
    <thead>
      <tr>
        <th class="docs"><h1>ace.coffee</th>
        <th class="code"></th>
      </tr>
    </thead>
    <tbody>
      
        <tr>
          <td class="docs"><p>!/usr/bin/env coffee</p></td>
          <td class="code"><div class="highlight"><pre><div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span> <span class="s2">&quot;fs&quot;</span>

<span class="nv">say = </span><span class="nf">(splat...) -&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">splat</span>
<span class="nv">die = </span><span class="nf">(splat...) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">splat</span> <span class="k">if</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">length</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="mi">1</span>

<span class="p">{</span><span class="nx">spawn</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s2">&quot;child_process&quot;</span>
<span class="p">{</span><span class="nx">OptionParser</span><span class="p">}</span>  <span class="o">=</span> <span class="nx">require</span> <span class="s2">&quot;coffee-script/lib/coffee-script/optparse&quot;</span>

<span class="nv">options =</span>
  <span class="nv">create: </span><span class="p">[]</span>
  <span class="nv">json: </span><span class="p">[]</span>
  <span class="nv">run: </span><span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--processes [COUNT]&quot;</span><span class="p">,</span> <span class="s2">&quot;run multiple processes&quot;</span> <span class="p">]</span> <span class="p">]</span>
  <span class="nv">progress: </span><span class="p">[]</span>

<span class="nv">args = </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">if</span> <span class="nv">opts = </span><span class="nx">options</span><span class="p">[</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
  <span class="nv">action = </span><span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
<span class="k">else</span>
  <span class="nv">action = </span><span class="s2">&quot;piped&quot;</span>
  <span class="nv">opts = </span><span class="nx">options</span><span class="p">.</span><span class="nx">run</span>

<span class="nv">parser = </span><span class="k">new</span> <span class="nx">OptionParser</span> <span class="nx">opts</span>

<span class="nv">usage = </span><span class="nf">(message) -&gt;</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;error: #{message}\n&quot;</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">help</span><span class="p">()</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;\n&quot;</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="mi">1</span>

<span class="k">try</span>
  <span class="nv">options = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">args</span>
<span class="k">catch</span> <span class="nx">e</span>
  <span class="nx">usage</span> <span class="s2">&quot;Invalid arguments.&quot;</span>

<span class="nv">piped = </span><span class="o">-&gt;</span>
  <span class="nv">formatter = </span><span class="nx">spawn</span> <span class="nx">__filename</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;progress&quot;</span> <span class="p">],</span> <span class="nv">customFds: </span><span class="p">[</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">]</span>
  <span class="nx">formatter</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="nf">(code) -&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="nx">code</span> <span class="k">if</span> <span class="nx">code</span> <span class="o">isnt</span> <span class="mi">0</span>
  <span class="nv">runner = </span><span class="nx">spawn</span> <span class="nx">__filename</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;run&quot;</span> <span class="p">].</span><span class="nx">concat</span> <span class="nx">args</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">formatter</span><span class="p">.</span><span class="nx">stdin</span><span class="p">)</span>
  <span class="nx">runner</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="nf">(code) -&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="nx">code</span> <span class="k">if</span> <span class="nx">code</span> <span class="o">isnt</span> <span class="mi">0</span>

<span class="nv">json = </span><span class="o">-&gt;</span>
  <span class="nv">object = </span><span class="p">{}</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">resume</span><span class="p">()</span>
  <span class="nx">parse</span> <span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">,</span> <span class="nf">(program) -&gt;</span>
    <span class="k">switch</span> <span class="nx">program</span><span class="p">.</span><span class="nx">type</span>
      <span class="k">when</span> <span class="s2">&quot;run&quot;</span>
        <span class="nx">object</span><span class="p">[</span><span class="nx">program</span><span class="p">.</span><span class="nx">file</span><span class="p">]</span> <span class="o">=</span>
          <span class="nv">time: </span><span class="nx">program</span><span class="p">.</span><span class="nx">time</span>
          <span class="nv">expected: </span><span class="nx">program</span><span class="p">.</span><span class="nx">expected</span>
          <span class="nv">tests: </span><span class="p">[]</span>
      <span class="k">when</span> <span class="s2">&quot;test&quot;</span>
        <span class="p">{</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">passed</span><span class="p">,</span> <span class="nx">skip</span><span class="p">,</span> <span class="nx">todo</span><span class="p">,</span> <span class="nx">comment</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">program</span>
        <span class="nx">object</span><span class="p">[</span><span class="nx">file</span><span class="p">].</span><span class="nx">tests</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">passed</span><span class="p">,</span> <span class="nx">skip</span><span class="p">,</span> <span class="nx">todo</span><span class="p">,</span> <span class="nx">comment</span> <span class="p">}</span>
      <span class="k">when</span> <span class="s2">&quot;exit&quot;</span>
        <span class="nx">extend</span> <span class="nx">object</span><span class="p">[</span><span class="nx">program</span><span class="p">.</span><span class="nx">file</span><span class="p">],</span>
          <span class="nv">actual: </span><span class="nx">program</span><span class="p">.</span><span class="nx">actual</span>
          <span class="nv">duration: </span><span class="nx">program</span><span class="p">.</span><span class="nx">time</span> <span class="o">-</span> <span class="nx">program</span><span class="p">.</span><span class="nx">start</span>
          <span class="nv">code: </span><span class="nx">program</span><span class="p">.</span><span class="nx">code</span>
      <span class="k">when</span> <span class="s2">&quot;eof&quot;</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">object</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;\n&quot;</span>

<span class="nv">progress = </span><span class="o">-&gt;</span>
  <span class="nv">colorize  = </span><span class="nf">(color) -&gt;</span> <span class="nf">(text) -&gt;</span> <span class="s2">&quot;#{color}#{text}\u001B[39m&quot;</span>
  <span class="nv">red       = </span><span class="nx">colorize</span><span class="p">(</span><span class="s2">&quot;\u001B[31m&quot;</span><span class="p">)</span>
  <span class="nv">green     = </span><span class="nx">colorize</span><span class="p">(</span><span class="s2">&quot;\u001B[32m&quot;</span><span class="p">)</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">resume</span><span class="p">()</span>
  <span class="nv">durations = </span><span class="p">{}</span>
  <span class="nv">displayed = </span><span class="kc">null</span>
  <span class="nv">programs = </span><span class="p">{}</span>
  <span class="nv">styling = </span><span class="nf">({ time, file, start, passed, actual, bailed, expected }) -&gt;</span>
    <span class="k">if</span> <span class="nx">passed</span> <span class="o">&lt;</span> <span class="nx">actual</span> <span class="o">or</span> <span class="nx">bailed</span>
      <span class="nx">extend</span> <span class="nx">programs</span><span class="p">[</span><span class="nx">file</span><span class="p">],</span>
        <span class="nv">status: </span><span class="s2">&quot;Failure&quot;</span>
        <span class="nv">color: </span><span class="nx">red</span>
        <span class="nv">icon: </span><span class="s2">&quot;\u2718&quot;</span>
    <span class="p">{</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">icon</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">programs</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span>
    <span class="nv">time = </span><span class="s2">&quot;#{time - start}&quot;</span>
    <span class="nv">time = </span><span class="s2">&quot;00#{time}&quot;</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="nx">time</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span>
    <span class="nv">time = </span><span class="s2">&quot;     #{time}&quot;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\d{3})$/</span><span class="p">,</span> <span class="s2">&quot;.$1&quot;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
    <span class="nv">summary = </span><span class="s2">&quot;(#{passed}/#{expected}) #{time}&quot;</span>
    <span class="nv">dots = </span><span class="nb">Array</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">66</span> <span class="o">-</span> <span class="nx">file</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">summary</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="nx">join</span> <span class="s2">&quot;.&quot;</span>
    <span class="s2">&quot; #{color icon} #{file} #{dots} #{summary} #{color(status)}\r&quot;</span>
  <span class="nv">failed = </span><span class="p">[]</span>
  <span class="nx">parse</span> <span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">,</span> <span class="nf">(program) -&gt;</span>
    <span class="p">{</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">file</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">program</span>
    <span class="k">switch</span> <span class="nx">type</span>
      <span class="k">when</span> <span class="s2">&quot;run&quot;</span>
        <span class="nx">displayed</span> <span class="o">or=</span> <span class="nx">file</span>
        <span class="nx">programs</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span> <span class="o">or=</span>
          <span class="nv">status: </span><span class="s2">&quot;Success&quot;</span>
          <span class="nv">color: </span><span class="nx">green</span>
          <span class="nv">start: </span><span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span>
          <span class="nv">time: </span><span class="mi">0</span>
          <span class="nv">actual: </span><span class="mi">0</span>
          <span class="nv">passed: </span><span class="mi">0</span>
          <span class="nv">expected: </span><span class="nx">program</span><span class="p">.</span><span class="nx">expected</span>
          <span class="nv">icon: </span><span class="s2">&quot;\u2713&quot;</span>
    <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;eof&quot;</span>
      <span class="nv">actual = </span><span class="mi">0</span>
      <span class="nv">passed = </span><span class="mi">0</span>
      <span class="nv">expected = </span><span class="mi">0</span>
      <span class="nv">time = </span><span class="mi">0</span>
      <span class="nv">start = </span><span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span>
      <span class="nv">count = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">program</span> <span class="k">of</span> <span class="nx">programs</span>
        <span class="nx">count</span><span class="o">++</span>
        <span class="nx">actual</span> <span class="o">+=</span> <span class="nx">program</span><span class="p">.</span><span class="nx">actual</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nx">passed</span> <span class="o">+=</span> <span class="nx">program</span><span class="p">.</span><span class="nx">passed</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nx">expected</span> <span class="o">+=</span> <span class="nx">program</span><span class="p">.</span><span class="nx">expected</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">program</span><span class="p">.</span><span class="nx">time</span>
        <span class="nv">start = </span><span class="nx">program</span><span class="p">.</span><span class="nx">start</span> <span class="k">if</span> <span class="nx">program</span><span class="p">.</span><span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">start</span>
        <span class="nv">time = </span><span class="nx">program</span><span class="p">.</span><span class="nx">time</span> <span class="k">if</span> <span class="nx">program</span><span class="p">.</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="nx">time</span>
      <span class="k">if</span> <span class="nx">passed</span> <span class="o">is</span> <span class="nx">expected</span>
        <span class="nv">icon = </span><span class="s2">&quot;\u2713&quot;</span>
        <span class="nv">status = </span><span class="s2">&quot;Success&quot;</span>
        <span class="nv">color = </span><span class="nx">green</span>
      <span class="k">else</span>
        <span class="nv">color = </span><span class="nx">red</span>
        <span class="nv">icon = </span><span class="s2">&quot;\u2718&quot;</span>
        <span class="nv">status = </span><span class="s2">&quot;Failure&quot;</span>
      <span class="nv">file = </span><span class="s2">&quot;Total tests: #{count}&quot;</span>
      <span class="nv">time = </span><span class="s2">&quot;#{time - start}&quot;</span>
      <span class="nv">time = </span><span class="s2">&quot;00#{time}&quot;</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="nx">time</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span>
      <span class="nv">time = </span><span class="s2">&quot;     #{time}&quot;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\d{3})$/</span><span class="p">,</span> <span class="s2">&quot;.$1&quot;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
      <span class="nv">summary = </span><span class="s2">&quot;(#{passed}/#{expected}) #{time}&quot;</span>
      <span class="nv">summary = </span><span class="s2">&quot;(#{passed}/#{expected}) #{time}&quot;</span>
      <span class="nv">dots = </span><span class="nb">Array</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">66</span> <span class="o">-</span> <span class="nx">file</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">summary</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="nx">join</span> <span class="s2">&quot;.&quot;</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">79</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot; #{color icon} #{file} #{dots} #{summary} #{color(status)}\n&quot;</span>
    <span class="k">else</span>
      <span class="nx">programs</span><span class="p">[</span><span class="nx">file</span><span class="p">].</span><span class="nv">duration = </span><span class="nx">time</span> <span class="o">-</span> <span class="nx">start</span>
    <span class="k">switch</span> <span class="nx">type</span>
      <span class="k">when</span> <span class="s2">&quot;test&quot;</span>
        <span class="k">if</span> <span class="nx">file</span> <span class="o">is</span> <span class="nx">displayed</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="nx">styling</span><span class="p">(</span><span class="nx">program</span><span class="p">)</span>
      <span class="k">when</span> <span class="s2">&quot;bail&quot;</span>
        <span class="nx">programs</span><span class="p">[</span><span class="nx">file</span><span class="p">].</span><span class="nv">bailed = </span><span class="kc">true</span>
      <span class="k">when</span> <span class="s2">&quot;exit&quot;</span>
        <span class="nx">programs</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extend</span> <span class="nx">programs</span><span class="p">[</span><span class="nx">file</span><span class="p">],</span> <span class="nx">program</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="nx">styling</span><span class="p">(</span><span class="nx">program</span><span class="p">)</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;\n&quot;</span>
        <span class="k">if</span> <span class="nx">program</span><span class="p">.</span><span class="nx">code</span> <span class="o">isnt</span> <span class="mi">0</span>
          <span class="nx">failed</span><span class="p">.</span><span class="nx">push</span> <span class="nx">program</span></pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>delete programs[file]</p></td>
          <td class="code"><div class="highlight"><pre>
        <span class="nv">candidates = </span><span class="p">(</span><span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">programs</span><span class="p">)</span>
        <span class="nx">candidates</span><span class="p">.</span><span class="nx">sort</span> <span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">duration</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">duration</span>
        <span class="nv">displayed = </span><span class="nx">candidates</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">file</span>
  <span class="nv">tattled = </span><span class="p">{}</span>
  <span class="nv">tattle = </span><span class="nf">(message) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">tattled</span><span class="p">[</span><span class="nx">message</span><span class="p">]</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;\n#{message}&quot;</span>
      <span class="nx">tattled</span><span class="p">[</span><span class="nx">message</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>

<span class="nv">parser =</span>
  <span class="nv">plan: </span><span class="nf">(plan) -&gt;</span>
    <span class="k">if</span> <span class="nv">match = </span><span class="sr">/^1..(\d+)$/</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">plan</span>
      <span class="p">{</span> <span class="nv">expected: </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="p">}</span>
  <span class="nv">bailout: </span><span class="nf">(bailout) -&gt;</span>
    <span class="k">if</span> <span class="nv">match = </span><span class="sr">/^Bail out!(?:\s+(.*))?$/</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">bailout</span>
      <span class="nv">message = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="p">{</span> <span class="nx">message</span> <span class="p">}</span>
  <span class="nv">assertion: </span><span class="nf">(assert) -&gt;</span>
    <span class="k">if</span> <span class="nv">match = </span><span class="sr">/^(not\s+)?ok\s+\d+\s*(.*?)\s*$/</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">assert</span>
      <span class="p">[</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">message</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="nv">ok = </span><span class="o">not</span> <span class="nx">failed</span><span class="o">?</span>
      <span class="p">[</span> <span class="nx">comment</span><span class="p">,</span> <span class="nx">skip</span><span class="p">,</span> <span class="nx">todo</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">]</span>
      <span class="k">if</span> <span class="nx">message</span><span class="o">?</span>
        <span class="p">[</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">comment</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\s+#\s+/</span><span class="p">,</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="nx">comment</span><span class="o">?</span>
          <span class="k">if</span> <span class="nv">skip = </span><span class="p">(</span><span class="nv">match = </span><span class="sr">/^skip\s(.*)$/i</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">comment</span><span class="p">)</span><span class="o">?</span>
            <span class="nv">comment = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="k">if</span> <span class="nv">todo = </span><span class="p">(</span><span class="nv">match = </span><span class="sr">/^todo\s(.*)$/i</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">comment</span><span class="p">)</span><span class="o">?</span>
            <span class="nv">comment = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="p">{</span> <span class="nx">ok</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="nx">skip</span><span class="p">,</span> <span class="nx">todo</span> <span class="p">}</span>

<span class="nv">extend = </span><span class="nf">(destination, sources...) -&gt;</span>
  <span class="k">for</span> <span class="nx">source</span> <span class="k">in</span> <span class="nx">sources</span>
    <span class="nx">destination</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">source</span>
  <span class="nx">destination</span>

<span class="nv">parse = </span><span class="nf">(stream, callback) -&gt;</span>
  <span class="nv">programs = </span><span class="p">{}</span>
  <span class="p">[</span> <span class="nx">out</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;&quot;</span> <span class="p">]</span>
  <span class="nv">count = </span><span class="mi">0</span>
  <span class="nx">stream</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s2">&quot;utf8&quot;</span>
  <span class="nx">stream</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
    <span class="nx">out</span>  <span class="o">+=</span> <span class="nx">chunk</span>
    <span class="nv">lines = </span><span class="nx">out</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\n/</span>
    <span class="nv">out   = </span><span class="nx">lines</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">lines</span>
      <span class="nx">count</span><span class="o">++</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nv">match = </span><span class="sr">///</span>
        <span class="sr">^</span>
<span class="sr">        (\d+)       </span><span class="c1"># time</span>
        <span class="sr">\s+</span>
<span class="sr">        (\w+)       </span><span class="c1"># type</span>
        <span class="sr">\s+</span>
<span class="sr">        ([^\s]+)    </span><span class="c1"># file</span>
        <span class="sr">\s*</span>
<span class="sr">        (.*)        </span><span class="c1"># rest</span>
        <span class="sr">$</span>
<span class="sr">      ///</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">line</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;cannot parse line #{count}&quot;</span>
      <span class="p">[</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">rest</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="nv">time = </span><span class="nb">parseInt</span> <span class="nx">time</span>
      <span class="nv">program = </span><span class="nx">programs</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span> <span class="o">or=</span>
        <span class="nv">passed: </span><span class="mi">0</span>
        <span class="nv">actual: </span><span class="mi">0</span>
      <span class="k">switch</span> <span class="nx">type</span>
        <span class="k">when</span> <span class="s2">&quot;test&quot;</span>
          <span class="nv">record = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">assertion</span> <span class="nx">rest</span>
          <span class="nx">program</span><span class="p">.</span><span class="nx">actual</span><span class="o">++</span>
          <span class="nx">program</span><span class="p">.</span><span class="nx">passed</span><span class="o">++</span> <span class="k">if</span> <span class="nx">record</span><span class="p">.</span><span class="nx">ok</span>
          <span class="nx">extend</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">program</span><span class="p">,</span> <span class="p">{</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">type</span> <span class="p">}</span>
          <span class="nx">callback</span> <span class="nx">record</span>
        <span class="k">when</span> <span class="s2">&quot;run&quot;</span>
          <span class="nv">program.start = </span><span class="nx">time</span>
          <span class="nx">callback</span> <span class="nx">extend</span> <span class="nx">program</span><span class="p">,</span> <span class="p">{</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">file</span> <span class="p">}</span>
        <span class="k">when</span> <span class="s2">&quot;plan&quot;</span>
          <span class="nv">record = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">plan</span> <span class="nx">rest</span>
          <span class="nv">program.expected = </span><span class="nx">record</span><span class="p">.</span><span class="nx">expected</span>
          <span class="nx">extend</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">program</span><span class="p">,</span> <span class="p">{</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">type</span> <span class="p">}</span>
          <span class="nx">callback</span> <span class="nx">record</span>
        <span class="k">when</span> <span class="s2">&quot;bail&quot;</span>
          <span class="nv">record = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">bailout</span> <span class="nx">rest</span>
          <span class="nv">program.bailed = </span><span class="kc">true</span>
          <span class="nx">extend</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">program</span><span class="p">,</span> <span class="p">{</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">type</span> <span class="p">}</span>
          <span class="nx">callback</span> <span class="nx">record</span>
        <span class="k">when</span> <span class="s2">&quot;exit&quot;</span>
          <span class="nv">code = </span><span class="nb">parseInt</span> <span class="nx">rest</span><span class="p">,</span> <span class="mi">10</span>
          <span class="k">if</span> <span class="nb">isNaN</span> <span class="nx">code</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;cannot read exit code #{code} on line #{count}&quot;</span>
          <span class="nv">record = </span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">program</span><span class="p">,</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">time</span> <span class="p">}</span>
          <span class="nx">callback</span> <span class="nx">record</span>
        <span class="k">when</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span>
          <span class="nx">callback</span><span class="p">({</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nv">line: </span><span class="nx">rest</span> <span class="p">})</span>
        <span class="k">when</span> <span class="s2">&quot;eof&quot;</span>
          <span class="nx">callback</span><span class="p">({</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">type</span> <span class="p">})</span>
        <span class="k">else</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;unknown type #{type}&quot;</span>

<span class="nv">run = </span><span class="o">-&gt;</span>
  <span class="nv">programs = </span><span class="nx">options</span><span class="p">.</span><span class="nx">arguments</span>
  <span class="nv">parallel = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">program</span> <span class="k">in</span> <span class="nx">programs</span>
    <span class="k">if</span> <span class="sr">/\s+/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">program</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;program names cannot contain spaces: #{program}&quot;</span>
    <span class="nv">dirname = </span><span class="sr">/^(.*)\/.*/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">program</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">parallel</span><span class="p">[</span><span class="nx">dirname</span><span class="p">]</span> <span class="o">or=</span> <span class="p">{</span> <span class="nv">programs: </span><span class="p">[],</span> <span class="nv">time: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">running: </span><span class="kc">true</span> <span class="p">}</span>
    <span class="nx">parallel</span><span class="p">[</span><span class="nx">dirname</span><span class="p">].</span><span class="nx">programs</span><span class="p">.</span><span class="nx">push</span> <span class="nx">program</span>
  <span class="nv">parallel = </span><span class="p">(</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">parallel</span><span class="p">)</span>
  <span class="nv">failures = </span><span class="p">[]</span>
  <span class="nv">displayed = </span><span class="mi">0</span>

  <span class="nv">emit = </span><span class="nf">(file, type, message) -&gt;</span>
    <span class="nv">message = </span><span class="k">if</span> <span class="nx">message</span><span class="o">?</span> <span class="k">then</span> <span class="s2">&quot; #{message}&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="nv">type = </span><span class="s2">&quot;#{type}      &quot;</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;#{+new Date()} #{type} #{file}#{message}\n&quot;</span>

  <span class="nv">execute = </span><span class="nf">(program, index) -&gt;</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span>
    <span class="nv">test = </span><span class="nx">spawn</span> <span class="nx">program</span>
    <span class="nv">bailed = </span><span class="kc">false</span>

    <span class="nv">err = </span><span class="s2">&quot;&quot;</span>
    <span class="nx">test</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s2">&quot;utf8&quot;</span>
    <span class="nx">test</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
      <span class="nx">err</span>  <span class="o">+=</span> <span class="nx">chunk</span>
      <span class="nv">lines = </span><span class="nx">err</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\n/</span>
      <span class="nv">err   = </span><span class="nx">lines</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">lines</span>
        <span class="nx">emit</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>

    <span class="nv">out = </span><span class="s2">&quot;&quot;</span>
    <span class="nx">test</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s2">&quot;utf8&quot;</span>
    <span class="nx">test</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
      <span class="nx">out</span>  <span class="o">+=</span> <span class="nx">chunk</span>
      <span class="nv">lines = </span><span class="nx">out</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\n/</span>
      <span class="nv">out   = </span><span class="nx">lines</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">lines</span>
        <span class="k">if</span> <span class="nx">bailed</span>
          <span class="nx">emit</span> <span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="nx">line</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">assertion</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
          <span class="nx">emit</span> <span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="nx">line</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">plan</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
          <span class="nx">emit</span> <span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="nx">line</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">bailout</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
          <span class="nx">emit</span> <span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;bail&quot;</span><span class="p">,</span> <span class="nx">line</span>
        <span class="k">else</span>
          <span class="nx">emit</span> <span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="nx">line</span>

    <span class="nx">test</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="nf">(code) -&gt;</span>
      <span class="nx">emit</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span>
      <span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nv">time = time = </span><span class="mi">0</span>
      <span class="k">if</span> <span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">programs</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">execute</span><span class="p">(</span><span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">programs</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">index</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">next</span> <span class="o">&lt;</span> <span class="nx">parallel</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nv">running = </span><span class="kc">false</span>
        <span class="nv">displayed = </span><span class="nx">next</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">displayed</span> <span class="o">is</span> <span class="nx">index</span>
        <span class="nv">index = </span><span class="nx">next</span><span class="o">++</span>
        <span class="nx">execute</span><span class="p">(</span><span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">programs</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">index</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;eof&quot;</span><span class="p">)</span>

  <span class="nv">next = </span><span class="nx">options</span><span class="p">.</span><span class="nx">processes</span> <span class="o">or</span> <span class="mi">1</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">next</span><span class="p">]</span>
    <span class="nx">execute</span><span class="p">(</span><span class="nx">parallel</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">programs</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">i</span><span class="p">)</span> <span class="k">if</span> <span class="nx">parallel</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>

<span class="nv">ignore = </span><span class="o">-&gt;</span>
      <span class="k">for</span> <span class="nx">program_</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">parallel</span>
        <span class="k">if</span> <span class="nx">program_</span><span class="p">.</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="nx">time</span>
          <span class="nv">time = </span><span class="nx">program_</span><span class="p">.</span><span class="nx">time</span>
          <span class="nv">displayed = </span><span class="nx">i</span>
      <span class="k">if</span> <span class="nx">passed</span> <span class="o">isnt</span> <span class="nx">expected</span> <span class="o">or</span> <span class="nx">code</span> <span class="o">isnt</span> <span class="mi">0</span>
        <span class="nx">failures</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">passed</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">code</span> <span class="p">}</span>
      <span class="k">if</span> <span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">programs</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">execute</span><span class="p">(</span><span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">programs</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">index</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">next</span> <span class="o">&lt;</span> <span class="nx">parallel</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nv">running = </span><span class="kc">false</span>
        <span class="nv">displayed = </span><span class="nx">next</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">displayed</span> <span class="o">is</span> <span class="nx">index</span>
        <span class="nv">index = </span><span class="nx">next</span><span class="o">++</span>
        <span class="nx">execute</span><span class="p">(</span><span class="nx">parallel</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">programs</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">index</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">parallel</span> <span class="k">when</span> <span class="nx">value</span><span class="p">.</span><span class="nx">running</span><span class="p">).</span><span class="nx">length</span>
        <span class="k">for</span> <span class="nx">failure</span> <span class="k">in</span> <span class="nx">failures</span>
          <span class="nv">time = </span><span class="o">+</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">())</span> <span class="o">-</span> <span class="nx">start</span>
          <span class="p">{</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">passed</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="nx">time</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">failure</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;\n#{program} exited: #{code} (#{passed}/#{expected}) in #{time} ms\n&quot;</span>
        <span class="k">if</span> <span class="nx">end</span>
          <span class="nx">tattle</span> <span class="s2">&quot;test is writing after completion&quot;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nv">match = </span><span class="sr">/^1..(\d+)$/</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">line</span>
          <span class="k">if</span> <span class="nx">expected</span><span class="o">?</span>
            <span class="nx">tattle</span> <span class="s2">&quot;test sent multiple plans&quot;</span>
          <span class="k">else</span>
            <span class="nv">expected = </span><span class="nb">parseInt</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span>
            <span class="nv">end = </span><span class="nx">actual</span> <span class="o">isnt</span> <span class="mi">0</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nv">match = </span><span class="sr">/^(not\s+)?ok\s+(\d+)(?:\s+-\s*(.*?)\s*)?$/</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">line</span>
          <span class="p">[</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">message</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="nx">passed</span><span class="o">++</span>    <span class="nx">unless</span> <span class="nx">failed</span>
          <span class="nv">end = </span><span class="kc">true</span>  <span class="k">if</span> <span class="o">++</span><span class="nx">actual</span> <span class="o">is</span> <span class="nx">expected</span>
          <span class="nx">styling</span><span class="p">()</span>   <span class="k">if</span> <span class="nx">displayed</span> <span class="o">is</span> <span class="nx">index</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nv">match = </span><span class="sr">/^Bail out!(?:\s+(.*?)\s*)?$/</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">line</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;\nBail out! #{match[1]}\n&quot;</span>
          <span class="nv">tattle = </span><span class="o">-&gt;</span>
        <span class="k">else</span>
          <span class="nx">tattle</span> <span class="s2">&quot;test is writing out jibberish\n&quot;</span>

<span class="nv">create = </span><span class="o">-&gt;</span>
  <span class="nv">signature = </span><span class="p">[]</span>
  <span class="nv">plan = </span><span class="mi">0</span>
  <span class="nv">async = </span><span class="s2">&quot;&quot;</span>
  <span class="nv">harness = </span><span class="s2">&quot;./harness&quot;</span>
  <span class="k">for</span> <span class="nx">argument</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">arguments</span>
    <span class="k">if</span> <span class="nx">argument</span> <span class="o">is</span> <span class="s2">&quot;_&quot;</span>
      <span class="nv">async = </span><span class="s2">&quot;, _&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="sr">/^t(?:est)?\//</span><span class="p">.</span><span class="nx">test</span> <span class="nx">argument</span>
      <span class="nv">name = </span><span class="nx">argument</span>
    <span class="k">else</span> <span class="k">if</span> <span class="sr">/^\./</span><span class="p">.</span><span class="nx">test</span> <span class="nx">argument</span>
      <span class="nv">harness = </span><span class="nx">argument</span>
    <span class="k">else</span> <span class="k">if</span> <span class="sr">/^\d+/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">argument</span>
      <span class="nv">plan = </span><span class="nb">parseInt</span> <span class="nx">argument</span><span class="p">,</span> <span class="mi">10</span>
    <span class="k">else</span>
      <span class="nx">signature</span><span class="p">.</span><span class="nx">push</span> <span class="nx">argument</span>
  <span class="k">try</span>
    <span class="k">if</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">name</span>
      <span class="nx">die</span> <span class="s2">&quot;test file already exists: #{name}&quot;</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="k">throw</span> <span class="nx">e</span> <span class="nx">unless</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">is</span> <span class="s2">&quot;ENOENT&quot;</span>
  <span class="p">[</span> <span class="nx">directory</span><span class="p">,</span> <span class="nx">file</span> <span class="p">]</span> <span class="o">=</span> <span class="sr">/^(.*)\/(.*)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">..]</span>
  <span class="nv">harnessFile = </span><span class="s2">&quot;#{directory}/#{harness}.coffee&quot;</span>
  <span class="k">try</span>
    <span class="nv">stat = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">harnessFile</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">is</span> <span class="s2">&quot;ENOENT&quot;</span>
      <span class="nx">die</span> <span class="s2">&quot;cannot find harness #{harnessFile}&quot;</span>
    <span class="k">throw</span> <span class="nx">e</span>
  <span class="nv">shebang = </span><span class="sr">/^(.*)\n/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">harnessFile</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span> <span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;# --- EDIFY DIVIDER ---</span>
<span class="s2">    require(&quot;</span><span class="c1">#{harness}&quot;) 0, (context) -&gt;</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">context</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;\\n&quot;</span>

  <span class="s2">&quot;&quot;&quot;, &quot;</span><span class="nx">utf8</span><span class="s2">&quot;</span>
<span class="s2">  fs.chmodSync name, 0755</span>
<span class="s2">  output = &quot;&quot;</span>
<span class="s2">  inspect = spawn name</span>
<span class="s2">  inspect.stdout.setEncoding &quot;</span><span class="nx">utf8</span><span class="s2">&quot;</span>
<span class="s2">  inspect.stdout.on &quot;</span><span class="nx">data</span><span class="s2">&quot;, (chunk) -&gt; output += chunk</span>
<span class="s2">  inspect.on &quot;</span><span class="nx">exit</span><span class="s2">&quot;, (code) -&gt;</span>
<span class="s2">    fs.unlinkSync name</span>
<span class="s2">    if code isnt 0</span>
<span class="s2">      die &quot;</span><span class="nx">cannot</span> <span class="nx">generate</span> <span class="nx">inspection</span> <span class="nx">program</span><span class="s2">&quot;</span>
<span class="s2">    if async</span>
<span class="s2">      shebang += &quot;&quot;&quot;</span>
        <span class="err">\</span><span class="nx">nreturn</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;streamline/module&quot;</span><span class="p">)(</span><span class="nx">module</span><span class="p">)</span>
      <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    json = JSON.parse output.split(/\n/)[1]</span>
<span class="s2">    missing = []</span>
<span class="s2">    for arg in signature</span>
<span class="s2">      if json.indexOf(arg) is -1</span>
<span class="s2">        missing.push arg</span>
<span class="s2">    if missing.length</span>
<span class="s2">      die &quot;&quot;&quot;</span>
        <span class="nx">harness</span> <span class="nx">does</span> <span class="o">not</span> <span class="nx">provide</span> <span class="c1">#{missing.join(&quot;, &quot;)}</span>
        <span class="k">try</span><span class="o">:</span> <span class="c1">#{json.join(&quot;, &quot;)}</span>
      <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    fs.writeFileSync name, &quot;&quot;&quot;</span></pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>{shebang}</p></td>
          <td class="code"><div class="highlight"><pre>
      <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;#{harness}&quot;</span><span class="p">)</span> <span class="c1">#{plan}, ({ #{signature.join(&quot;, &quot;)} }#{async}) -&gt;</span>
</pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>{shebang}</p></td>
          <td class="code"><div class="highlight"><pre>
    <span class="s2">&quot;&quot;&quot;, &quot;</span><span class="nx">utf8</span><span class="err">&quot;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">chmodSync</span> <span class="nx">name</span><span class="p">,</span> <span class="mi">0755</span>

<span class="p">({</span> <span class="nx">create</span><span class="p">,</span> <span class="nx">piped</span><span class="p">,</span> <span class="nx">json</span><span class="p">,</span> <span class="nx">run</span><span class="p">,</span> <span class="nx">progress</span> <span class="p">})[</span><span class="nx">action</span><span class="p">]()</span>
</pre></div>
</pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>Here be dragons.\n</p></td>
          <td class="code"><div class="highlight"><pre>    """, "utf8",    fs.chmodSync name, 0755,,({ create, piped, json, run, progress })[action](),</pre></div></td>
        </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
